---
title: "BMS"
author: "Yuxi Ke"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    theme: "flatly"
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
---

# Overview

Make biological pseudobulks for gene expression and peaks.
VST normalize and extract DESeq2 PCs.

Input:

    - An ArchR project after cell type annotation
    - A Seurat object after cell type annotation
    - A sample metadata csv file
    
Yuxi Ke, 06/04/2025

# Setup

```{r setup, include = FALSE, warning = FALSE, message=FALSE, echo=FALSE}
project_id <- "bms" # determines the name of the cache folder
doc_id     <- file.path("03-4_bio_pseudobulks/") # determines name of the subfolder of `figures` where pngs/pdfs are saved
dataout    <- file.path(here::here("Output/"), doc_id); dir.create(dataout, recursive = TRUE)
figout     <- file.path(here::here("Fig/"), doc_id); dir.create(figout, recursive = TRUE)

here::i_am(".gitignore")
knitr::opts_chunk$set(message = TRUE,
                      warning = FALSE,
                      error = FALSE,
                      cache = FALSE,
                      fig.path = figout,
                      fig.keep = "all",
                      dev = c("png", "pdf"),
                      cache.lazy = FALSE)

grDevices::pdf.options(useDingbats = FALSE)
options(knitr.table.format = "html") 
```

```{r Libraries, class.source="fold-hide", warning = FALSE, message = FALSE}
library(here)
library(dbscan)
library(dplyr)
library(tidyr)
library(Matrix)

library(Seurat)
library(ArchR)
library(DESeq2)

library(ggplot2)
library(ggpubr)
library(viridis)
library(ComplexHeatmap)
library(pheatmap)
library(patchwork)

library(clusterProfiler)
library("org.Mm.eg.db")
idType(OrgDb=org.Mm.eg.db)

reload <- function() {
    devtools::load_all("~/workspace/bms")
}

redoc <- function() {
    devtools::document("~/workspace/bms")
}

reload()
bms::setup_archr(); bms::set_theme()
set.seed(100)
```
***

# Load data

```{r Define file names and read data, include=FALSE}
location <- "local" # {"local", "sherlock"}

if (location == "local") {
    archr.proj.path <- here::here("Data/ArchRProjects/BMS_diff_motif")
    gex.obj.path <- here::here("Data/SeuratObjects/gex_gr.rds")
} else {
    oak.path <- "/oak/stanford/groups/wjg/kyx/data/bms"
    archr.proj.path <- file.path(oak.path, "archr/BMS_mm10")
    gex.obj.path <- file.path(oak.path, "seurat/BMS_clean.rds")
}

proj <- loadArchRProject(archr.proj.path, showLogo = FALSE)
gex <- readRDS(gex.obj.path)
sample_metadata <- load_sample_metadata(here::here("Data/Metadata/YK_sample_sheet.csv"))
```

# Preprocessing

Aggregate sample x cell type, and only keep pseudobulks with more than 15 cells
for both modalities.

Run VST to get pseudobulk-level PCs and PC loadings to use for PLS-DA.

## RNA

```{r Create RNA pseudobulks}
rna_pb <- bms::get_bio_pseudobulk(
    mat = Seurat::GetAssayData(gex, layer = "counts"),
    cell_metadata = gex@meta.data,
    type_col = "cell_type",
    sample_col = "orig.ident",
    sample_metadata = sample_metadata
)

rna_pb  <- rna_pb[, colData(rna_pb)$NumCells > 15]
print(dim(rna_pb))
```

VST for sample-level PCAs.

```{r Generic model for RNA PCs, message=FALSE}
all_cell_types <- bms::cell_types_diff
all_condition_pairs <- bms::condition_pairs_diff

metadata <- get_formatted_pb_metadata(rna_pb)
dds_rna <- DESeq2::DESeqDataSetFromMatrix(countData = counts(rna_pb),
                                      colData = metadata,
                                      design = ~ 1)
vsd_rna <- DESeq2::vst(dds_rna, blind = TRUE)
```

```{r Extract all RNA PCs to df}
mat <- assay(vsd_rna)                         # genes × samples
pca <- stats::prcomp(t(mat), center = TRUE)      # samples × PCs

# Percent variance explained by each PC
percentVar <- pca$sdev^2 / sum(pca$sdev^2)

# Build a data.frame of PC scores + metadata
scores_df <- as.data.frame(pca$x)        # columns: PC1, PC2, …
colnames(scores_df) <- sprintf("PC%02d", seq(length(colnames(scores_df))))
scores_df$sample <- rownames(scores_df)

meta_df <- as.data.frame(colData(vsd_rna))
meta_df$sample <- rownames(meta_df)
# meta_df$Time <- factor(meta_df$Time,
#                   levels = c("7d", "28d"),
#                   labels = c("d07", "d28"))
# meta_df$Recall <- factor(meta_df$Recall,
#                   levels = c(FALSE, TRUE),
#                   labels = c("N", "R"))

pc_df_rna <- merge(scores_df, meta_df, by = "sample")
```


## ATAC

```{r Load ATAC peaks}
fn <- file.path(here::here("Output/04-2b_DAR", "var_pb.rds"))
var_pb <- readRDS(fn)
atac_pb  <- var_pb[, colData(var_pb)$NumCells > 15]
print(dim(atac_pb))
```


```{r Generic model for ATAC PCs}
metadata_atac <- get_formatted_pb_metadata(atac_pb)
dds_atac <- DESeq2::DESeqDataSetFromMatrix(countData = counts(atac_pb),
                                      colData = metadata_atac,
                                      design = ~ 1)
# !! Use "poscounts" as there are many zeros and other methods won't work
dds_atac <- estimateSizeFactors(dds_atac, type = "poscounts")
vsd_atac <- DESeq2::varianceStabilizingTransformation(dds_atac, blind = TRUE)
```

```{r Extract all ATAC PCs to df}
mat <- assay(vsd_atac)                         # genes × samples
pca <- stats::prcomp(t(mat), center = TRUE)      # samples × PCs

# Percent variance explained by each PC
percentVar <- pca$sdev^2 / sum(pca$sdev^2)

# Build a data.frame of PC scores + metadata
scores_df <- as.data.frame(pca$x)        # columns: PC1, PC2, …
colnames(scores_df) <- sprintf("PC%02d", seq(length(colnames(scores_df))))
scores_df$sample <- rownames(scores_df)

pc_df_atac <- merge(scores_df, meta_df, by = "sample")
```


## ATAC gene scores
```{r Gene score PB}
geneScoreMat <- getMatrixFromProject(
  ArchRProj = proj,
  useMatrix = "GeneScoreMatrix"
)
```
```{r}
gene_score_pb <- bms::get_bio_pseudobulk(
    mat = Seurat::GetAssayData(gex, layer = "counts"),
    cell_metadata = gex@meta.data,
    type_col = "cell_type",
    sample_col = "orig.ident",
    sample_metadata = sample_metadata
)

rna_pb  <- rna_pb[, colData(rna_pb)$NumCells > 15]
print(dim(rna_pb))
```


# Save preprocessed data

```{r Save to dataout}
obj_names <- c("rna_pb", "vsd_rna", "pc_df_rna",
               "atac_pb", "vsd_atac", "pc_df_atac")

bms::save_rds_objects(obj_names, dataout)
```

# ATAC distal-only vsd

```{r Load ATAC peaks}
fn <- file.path(here::here("Output/04-2b_DAR", "var_pb.rds"))
var_pb <- readRDS(fn)
atac_pb <- var_pb[rowData(var_pb)$peakType == "Distal", colData(var_pb)$NumCells > 15]
# atac_pb  <- var_pb[, colData(var_pb)$NumCells > 15]
print(dim(atac_pb))
```


```{r Generic model for ATAC PCs}
metadata_atac <- get_formatted_pb_metadata(atac_pb)
dds_atac <- DESeq2::DESeqDataSetFromMatrix(countData = counts(atac_pb),
                                      colData = metadata_atac,
                                      design = ~ 1)
# !! Use "poscounts" as there are many zeros and other methods won't work
dds_atac <- estimateSizeFactors(dds_atac, type = "poscounts")
vsd_atac <- DESeq2::varianceStabilizingTransformation(dds_atac, blind = TRUE)
```

```{r Extract all ATAC PCs to df}
mat <- assay(vsd_atac)                         # genes × samples
pca <- stats::prcomp(t(mat), center = TRUE)      # samples × PCs

# Percent variance explained by each PC
percentVar <- pca$sdev^2 / sum(pca$sdev^2)

# Build a data.frame of PC scores + metadata
scores_df <- as.data.frame(pca$x)        # columns: PC1, PC2, …
colnames(scores_df) <- sprintf("PC%02d", seq(length(colnames(scores_df))))
scores_df$sample <- rownames(scores_df)

meta_df <- as.data.frame(colData(vsd_atac))
meta_df$sample <- rownames(meta_df)

pc_df_atac <- merge(scores_df, meta_df, by = "sample")
```

```{r}
obj_names <- c("atac_pb", "vsd_atac", "pc_df_atac")

distal_dir <- file.path(dataout, "distal"); dir.create(distal_dir)
bms::save_rds_objects(obj_names, distal_dir)
```

# Session info

```{r sinfo, cache = FALSE, class.source="fold-hide"}
sessionInfo()
```
