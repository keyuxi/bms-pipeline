---
title: "BMS"
author: "Yuxi Ke"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    theme: "flatly"
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r config, warning = FALSE}

# **MODIFY THIS CHUNK**
project_id <- "bms" # determines the name of the cache folder
doc_id     <- file.path("03-1_joint_per_cell_filtering") # determines name of the subfolder of `figures` where pngs/pdfs are saved
out        <- file.path(here::here("Output/"), doc_id); dir.create(out, recursive = TRUE)
figout     <- file.path(here::here("Fig"), doc_id); dir.create(figout, recursive = TRUE)
```

```{r setup, include = FALSE}

# NO NEED TO MODIFY THIS CHUNK
here::i_am(".gitignore")
knitr::opts_chunk$set(message = TRUE,
                      warning = FALSE,
                      error = FALSE,
                      cache = FALSE,
                      fig.path = figout,
                      fig.keep = "all",
                      dev = c("png", "pdf"),
                      cache.lazy = FALSE)

grDevices::pdf.options(useDingbats = FALSE)
options(knitr.table.format = "html") 

```

***

# Overview

This script combines per cell stats from both gex and ATAC parts
and filters doublet using combined scores.
Only cells in both modalities are kept.
Doublets are visualized in the ATAC data.

Input:
    - An ArchR project
    - A Seurat object
    
Output:
    - A new ArchR project
    - A new Seurat object
    
Yuxi Ke, 09/05/2024


# Libraries

```{r libs, warning = FALSE, message = FALSE}
library(here)
source(here::here("Scripts/Lib/util.R"))
source(here::here("Scripts/Lib/plotting_Greenleaf.R"))
source(here::here("Scripts/Lib/plotting.R"))

library(Seurat)
library(ArchR)
addArchRThreads(threads = parallel::detectCores() - 2) # 24 cores in total when on compute node, minus 2
addArchRGenome("mm10")

library(scDblFinder)
library(dplyr)

ggplot2::theme_set(theme_BOR())

set.seed(100)
```


# Load data

## Define file names

```{r}
archr.proj.path <- here::here("Data/ArchRProjects/BMS")
clean.archr.proj.path <- here::here("Data/ArchRProjects/BMS_clean")
gex.obj.path <- here::here("Data/SeuratObjects/gex_tagged.rds")
clean.gex.obj.path <- here::here("Data/SeuratObjects/gex_clean.rds")
```

## Read data

```{r}
Sys.setenv(HDF5_USE_FILE_LOCKING=FALSE, RHDF5_USE_FILE_LOCKING=FALSE)
proj <- loadArchRProject(archr.proj.path, showLogo = FALSE)
gex <- readRDS(gex.obj.path)
```


# Only keep shared cells

Only cells in both ATAC and GEX are kept.


```{r Only keep shared Cells}
joint <- getCellsInBothOnly(gex, proj)
# Double check that cell names match
stopifnot(joint$atac$cellNames == Cells(joint$gex))
```

Log cell number before and after.

```{r}
# sink(file.path(out, "cell_accounting.txt"))
cat("ATAC cells: ")
cat(nCells(proj))
cat("\nGEX cells: ")
cat(length(gex$orig.ident))
cat("\nJoint cells: ")
cat(nCells(joint$atac))
# sink()
```

# Doublets

```{r Print doublet calling results}
doublet_clasification <- table(joint$gex$scDblFinder_class)
print(doublet_clasification)
print(table(joint$gex$scDblFinder_class))
sprintf("%.1f%% of all cells called.", 
        100 * doublet_clasification[["doublet"]] / length(Cells(joint$gex))) %>% cat()

```

## ATAC-seq visualization

```{r Add to ArchR metadata}
joint$atac <- addCellColData(joint$atac, 
                             data = joint$gex$scDblFinder_class, 
                             name = "scDblFinder_class",
                             cells = Cells(joint$gex),
                             force = TRUE)
```



```{r Run ATAC LSI and UMAP for visualization}
if (! "IterativeLSI" %in% names(joint$atac@reducedDims)) {
    joint$atac<- addIterativeLSI(ArchRProj = joint$atac, 
                        useMatrix = "TileMatrix", 
                        name = "IterativeLSI", 
                        LSIMethod = 2,
                        force = TRUE)
}

if (! "UMAP" %in% names(joint$atac@embeddings)) {
    joint$atac <- addUMAP(joint$atac, name = "UMAP", force = T)
}
```


```{r UMAP visualization colored by doublet status}
p <- plotEmbedding(ArchRProj = joint$atac, colorBy = "cellColData", 
                   name = "scDblFinder_class", savePlot = F)
p + scale_color_manual(values = bms_color$doublet, guide = "legend") +
    theme_BOR() +
  labs(title = "UMAP Embedding: Doublets vs Singlets")
```


```{r Barplot of doublet proportions by sample}
sample_data <- as.data.frame(getCellColData(joint$atac))[,c("Sample", "scDblFinder_class")]
colnames(sample_data) <- c("Sample", "DoubletStatus")

ggplot(sample_data, aes(y = Sample, fill = DoubletStatus)) +
  geom_bar(position = "fill", orientation = "y") +
  theme_BOR() +
  labs(title = "Doublet Proportion by Sample", y = "Sample", x = "Proportion") +
  scale_fill_manual(values = bms_color$doublet)

```

# Filter cells out

```{r}
isKept <- (joint$gex$scDblFinder_class == "singlet") &
    (joint$gex$is_neuron) &
    (joint$atac$TSSEnrichment >= 5.25)
table(isKept)
cellsKept <- Cells(joint$gex)[isKept]
```

```{r}
subgex <- subset(joint$gex, cells = cellsKept)
saveRDS(subgex, clean.gex.obj.path)
```

```{r Save ArchR}
# To prevent ArchR project saving issues
Sys.setenv(HDF5_USE_FILE_LOCKING=FALSE, RHDF5_USE_FILE_LOCKING=FALSE)
subproj <- subsetCells(joint$atac, cellNames = cellsKept)
saveArchRProject(subproj,
                 outputDirectory = clean.archr.proj.path,
                 overwrite = TRUE,
                 dropCells = TRUE)
```

# Session info

```{r sinfo, cache = FALSE}
sessionInfo()
```
