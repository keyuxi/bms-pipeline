---
title: "BMS"
author: "Yuxi Ke"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    theme: "flatly"
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r config, warning = FALSE, include=FALSE}
here::i_am(".gitignore")

# Output and figures are saved to the same sub-folder
doc_id     <- file.path("peak_selection/")
out    <- file.path(here::here("data/atac/"), doc_id)
if (!dir.exists(out)) dir.create(out, recursive = TRUE)

knitr::opts_chunk$set(message = TRUE, warning = FALSE, error = FALSE, 
                      fig.path = out, fig.keep = "all", dev = c("png", "pdf"),
                      cache = FALSE, cache.lazy = FALSE)
grDevices::pdf.options(useDingbats = FALSE)
options(knitr.table.format = "html") 

library(ggplot2)
library(DESeq2)

reload <- function() devtools::load_all("~/gh/bms")
redoc <- function() devtools::document("~/gh/bms")
reload(); bms::setup_archr(); bms::set_theme();set.seed(100)
```

***
# Overview

Select variable peak features.

Input:

    - `BMS_diff_m`: An ArchR project
    
    - `config/samples.csv`
    
Output:

    - `/oak/stanford/groups/wjg/kyx/data/bms/pb/var_pb.rds`
    
    - `data/atac/peak_selection/var_peak_names.txt`: names of the variable peaks

# Load data

## Define file names

```{r, include=TRUE}
location <- "sherlock" # {"local", "sherlock"}

if (location == "local") {
    archr.proj.path <- here::here("Data/ArchRProjects/BMS_diff_m")
} else {
    oak.path <- "/oak/stanford/groups/wjg/kyx/data/bms"
    archr.proj.path <- file.path(oak.path, "archr/BMS_diff_m")
}

proj <- loadArchRProject(archr.proj.path, showLogo = FALSE)
sample_metadata <- load_sample_metadata(here::here("config/samples.csv"))
```

# Peak per pseudobulk

## Aggregate peaks

```{r}
peak <- bms::get_peak_mat_ranges(proj)

peak_pb <- bms::get_bio_pseudobulk(
    mat = peak$peak_mat,
    cell_metadata = proj@cellColData,
    feat_ranges = peak$peak_ranges,
    type_col = "cell_type",
    sample_col = "Sample",
    sample_metadata = sample_metadata
)

print(assay(peak_pb, "cpm")[1:10, 1:3])
```

```{r Prepare peak_pb and filtered}
# ########
# load_existing_peak_pb <- F
# ########
# fn <- file.path(out, "peak_pb.rds")
# 
# if (load_existing_peak_pb){
#     peak_pb <- readRDS(fn)
# } else{
#     saveRDS(peak_pb, fn)
# }
```

## Find significantly variable peaks

First, filter to detected peaks only. Use data-driven filter from the plots above.
```{r}
filtered_pb  <- bms::get_filtered_features(peak_pb,
                                        min_count_threshold = 10,
                                        min_sample_fraction = 0.05,
                                        min_sample_count    = 2,
                                        top_N               = NULL)
```


Then, model feature variance and find significantly variable ones.

```{r Size factors}
# Estimate size factors ====
dds_fs <- DESeqDataSetFromMatrix(
    countData = counts(filtered_pb),
    colData = colData(filtered_pb),
    design = ~ 1
)

dds_fs <- estimateSizeFactors(dds_fs)
assay(filtered_pb, "size_normed") <- DESeq2::counts(dds_fs, normalized = T)
```


```{r Dispersion and feature selection}
dds_fs <- estimateDispersions(dds_fs)

disp_df <- mcols(dds_fs) %>%
    as.data.frame() %>%
    dplyr::mutate(dispRatio = dispersion / dispFit,
                  log2dispRatio = log2(dispRatio),
                  pvalue = stats::pchisq(dispRatio, df = 1, lower.tail = F)) %>%
    dplyr::select(baseMean, baseVar, dispersion, dispFit, dispRatio, log2dispRatio, pvalue)

# hist(disp_df$pvalue)
var_feat_deseq <- disp_df %>%
    dplyr::filter(pvalue < 0.1) %>%
    rownames()

cat(sprintf("Number of DESeq features: %d\n", length(var_feat_deseq)))
```

We will continue with this.

```{r Subset to variable features}
var_pb  <- filtered_pb[var_feat_deseq, , drop = FALSE]

var_peak_names <- names(var_pb@rowRanges)
writeLines(var_peak_names, file.path(out, "var_peak_names.txt"))
```

```{r}
########
load_existing_variable_pb <- F
########
fn <- file.path(oak.path, "pb", "var_pb.rds")

if (load_existing_variable_pb){
    var_pb <- readRDS(fn)
} else{
    saveRDS(var_pb, fn)
}
```

```{r Peak count distribution histograms}
var_peak_counts <- assay(var_pb)
hist(log10(var_peak_counts + 1), breaks = 10)
hist(log10(var_peak_counts[var_peak_counts > 0] + 1), breaks = 10)
```
